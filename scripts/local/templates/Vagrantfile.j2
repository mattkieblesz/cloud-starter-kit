# -*- mode: ruby -*-
require 'fileutils'

unless Vagrant.has_plugin?("vagrant-hostsupdater")
	system("vagrant plugin install vagrant-hostsupdater")
	exec "vagrant #{ARGV.join' '}"
end

def ensureDir(dir)
	dir = File.expand_path(dir)
	if !File.directory? dir
		FileUtils::mkpath(dir)
	end
	return dir
end


Vagrant.configure(2) do |config|
	config.vm.box = "ubuntu/trusty64"
	config.vm.box_check_update = false

	config.ssh.forward_agent = true

	config.vm.network :forwarded_port, guest: 8080, host: {{ service.vagrant.port }}
	config.vm.network :private_network, ip: "{{ service.vagrant.ip }}"
	config.hostsupdater.aliases = [ "{{ service.name }}.app.internal" ]

	{% if service.vagrant.sync %}
	config.vm.synced_folder ensureDir(File.join('{{ base_dir }}', "workspace", "{{ service.name }}")),
		"/home/{{ service.name }}/code",
		mount_options: ["dmode=777,fmode=777"]
	{% endif %}

	config.vm.provider :virtualbox do |vb|
		vb.customize ["modifyvm", :id, "--memory", 1024]
		vb.customize ["modifyvm", :id, "--cpus", 1]
		vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
		vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
	end

	config.vm.provision "ansible" do |ansible|
		ansible.playbook = "{{ base_dir }}/plays/{{ service.name }}.yml"
		ansible.extra_vars = {
			'hosts' => 'default',
			'pwd' => File.dirname(__FILE__),
		}
	end

end
